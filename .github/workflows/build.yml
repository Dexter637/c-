name: Build and Package DeployTool

on:
  push:
    branches:
      - main  # 可以根据实际情况修改触发工作流的分支，比如'master'等

jobs:
  build_and_package:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: true  # 如果项目包含子模块，添加此参数以确保子模块也被拉取

    - name: Create build directory
      shell: powershell
      run: |
        if (!(Test-Path -Path build)) {
          New-Item -ItemType Directory -Path build -Force
        }
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        platform: win64
        dir: ${{ github.workspace }}/build/Qt  # 修改Qt安装目录为build/Qt

    - name: Configure build environment
      shell: powershell
      run: |
        $env:PATH += ";${{ github.workspace }}/build/Qt/5.15.2/msvc2019_64/bin"  # 修改PATH环境变量配置，指向build/Qt下的bin目录
        [System.Environment]::SetEnvironmentVariable("PATH", $env:PATH, [System.EnvironmentVariableTarget]::Machine)
    - name: Build the project
      shell: powershell
      run: |
        qmake -o build/  # 通过 -o 参数指定构建输出目录为build，确保生成的文件进入build目录
        nmake -f build/Makefile  # 指定在build目录下查找Makefile进行构建，如果是mingw32-make同理，确保操作都在build目录相关环境下
    - name: Package application with windeployqt
      shell: powershell
      run: |
        windeployqt --dir build/release --force build/DeployTool.exe  # 修改相关文件路径为build目录下的对应路径
        Compress-Archive -Path build/release/* -DestinationPath build/DeployTool.zip  # 压缩文件也放在build目录下
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: DeployTool
        path: build/DeployTool.zip  # 上传build目录下的压缩文件
